<match <%= @pattern %>>
<%- if @config.is_a?( Array ) -%>
  type copy
  <%- @config.each do |config| -%>
  <store>
    <%- config.sort_by{ |key,val| key == 'servers' ? 'z' : key }.each do |key, val| -%>
      <%- if key == 'servers' -%>
        <%- val.each do |server| -%>
        <server>
          <%- server.sort_by{|k,v|k}.each do |k,v| -%>
          <%= k %> <%= v %>
          <%- end -%>
        </server>
        <%- end -%>
      <%- else -%>
        <%= key %> <%= val %>
      <%- end -%>
    <%- end -%>
  </store>
  <%- end -%>
<%- else -%>
  <%- @config.sort_by{ |key,val| key == 'servers' ? 'z' : key }.each do |key, val| -%>
    <%- if key == 'servers' -%>
      <%- val.each do |server| -%>
      <server>
        <%- server.sort_by{|k,v|k}.each do |k,v| -%>
        <%= k %> <%= v %>
        <%- end -%>
      </server>
      <%- end -%>
    <%- else -%>
      <%= key %> <%= val %>
    <%- end -%>
  <%- end -%>
<%- end -%>
</match>
